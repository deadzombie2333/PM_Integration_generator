# 收银台测试上线

## 测试流程概览

```
集成开发 -> 初步测试 -> 提交验收 -> 验收通过 -> 配置生产环境 -> 正式上线
```

## 1. 集成开发

### 1.1 完成集成步骤

确保已完成以下集成步骤：
- ✓ 注册开发者中心账号
- ✓ 配置测试环境信息
- ✓ 实现创建支付接口调用
- ✓ 实现收银台页面跳转
- ✓ 实现支付结果回调处理
- ✓ 实现支付订单查询
- ✓ 实现错误处理

### 1.2 代码自检清单

#### 请求处理
- [ ] 正确生成请求签名
- [ ] 正确设置请求头
- [ ] 正确构造请求参数
- [ ] 处理网络超时
- [ ] 处理网络异常

#### 响应处理
- [ ] 验证响应签名
- [ ] 解析响应数据
- [ ] 处理错误响应
- [ ] 记录请求日志

#### 回调处理
- [ ] 验证回调签名
- [ ] 解析回调数据
- [ ] 幂等性处理
- [ ] 快速返回响应（5秒内）
- [ ] 记录回调日志

#### 安全性
- [ ] 使用HTTPS
- [ ] 保护密钥安全
- [ ] 验证金额一致性
- [ ] 防止重复支付

## 2. 初步测试

### 2.1 测试环境配置

确认测试环境配置正确：
- 测试环境URL: `https://pay-gate-uat.payermax.com/aggregate-pay/api/gateway/`
- 测试商户号
- 测试AppID
- 测试密钥对

### 2.2 功能测试

#### 2.2.1 创建支付测试

**测试场景1: 使用所有支付方式**
```bash
# 发起请求
curl --request POST \
  --url https://pay-gate-uat.payermax.com/aggregate-pay/api/gateway/orderAndPay \
  --header 'Content-Type: application/json' \
  --header 'sign: <your_signature>' \
  --data '{...}'

# 预期结果
- 返回code为APPLY_SUCCESS
- 返回redirectUrl
- 返回tradeToken
- status为PENDING
```

**测试场景2: 指定支付方式**
- 测试指定WALLET
- 测试指定CARD
- 测试指定具体支付机构

**测试场景3: 不同金额**
- 测试小额支付（如$0.01）
- 测试正常金额（如$9.99）
- 测试大额支付（如$999.99）

**测试场景4: 不同货币**
- 测试USD
- 测试IDR
- 测试其他支持的货币

#### 2.2.2 收银台跳转测试

**测试步骤**：
1. 获取redirectUrl
2. 在浏览器中打开
3. 检查页面展示

**检查项**：
- [ ] 页面正常加载
- [ ] 显示正确的金额和货币
- [ ] 显示正确的商品信息
- [ ] 显示正确的支付方式列表
- [ ] 语言显示正确
- [ ] 移动端自适应正常

#### 2.2.3 支付流程测试

**测试步骤**：
1. 选择支付方式
2. 完成支付操作
3. 查看支付结果页
4. 点击返回按钮
5. 检查跳转到商户页面

**检查项**：
- [ ] 支付流程顺畅
- [ ] 支付结果页展示正确
- [ ] 返回商户页面成功
- [ ] URL参数正确

#### 2.2.4 回调通知测试

**测试步骤**：
1. 完成一笔支付
2. 等待接收回调通知
3. 验证回调数据

**检查项**：
- [ ] 收到回调通知
- [ ] 签名验证通过
- [ ] 订单号正确
- [ ] 金额正确
- [ ] 状态正确
- [ ] 返回响应成功

**回调重试测试**：
1. 第一次回调返回失败响应
2. 检查是否收到重试通知
3. 返回成功响应
4. 确认不再收到通知

#### 2.2.5 订单查询测试

**测试步骤**：
1. 使用商户订单号查询
2. 使用PayerMax订单号查询
3. 查询不存在的订单

**检查项**：
- [ ] 查询成功返回正确数据
- [ ] 查询不存在订单返回正确错误码
- [ ] 签名验证通过

### 2.3 异常测试

#### 2.3.1 网络异常测试

**测试场景**：
- 请求超时
- 网络中断
- 服务器返回5xx错误

**检查项**：
- [ ] 有合理的超时设置
- [ ] 有重试机制
- [ ] 有错误提示
- [ ] 不会重复创建订单

#### 2.3.2 用户行为测试

**测试场景**：
- 用户中途关闭页面
- 用户支付超时
- 用户取消支付
- 用户重复支付

**检查项**：
- [ ] 订单状态正确
- [ ] 不会重复扣款
- [ ] 有合理的提示

#### 2.3.3 数据异常测试

**测试场景**：
- 金额为0
- 金额为负数
- 货币代码错误
- 国家代码错误
- 订单号重复

**检查项**：
- [ ] 返回正确的错误码
- [ ] 有错误提示
- [ ] 不会创建异常订单

### 2.4 测试用例记录

建议记录以下测试信息：

| 测试时间 | 订单号 | 金额 | 货币 | 支付方式 | 结果 | 备注 |
|---------|--------|------|------|---------|------|------|
| 2025-01-08 10:00 | TEST001 | 9.99 | USD | CARD | 成功 | - |
| 2025-01-08 10:05 | TEST002 | 53000 | IDR | WALLET | 成功 | DANA |
| ... | ... | ... | ... | ... | ... | ... |

## 3. 提交验收

### 3.1 准备验收材料

需要提供以下信息给PayerMax技术支持：

#### 基本信息
- 商户名称
- 商户号
- AppID
- 联系人和联系方式

#### 测试订单信息
至少提供5笔成功的测试订单：

```
订单1:
- 商户订单号: TEST001
- PayerMax订单号: T2019051406423972799219
- 金额: 9.99 USD
- 支付方式: CARD
- 支付时间: 2025-01-08 10:00:00
- 状态: SUCCESS

订单2:
- 商户订单号: TEST002
- PayerMax订单号: T2019051409242877928306
- 金额: 53000 IDR
- 支付方式: WALLET (DANA)
- 支付时间: 2025-01-08 10:05:00
- 状态: SUCCESS

...
```

#### 集成说明
- 使用的集成模式（收银台模式）
- 支持的支付方式
- 支持的国家和货币
- 特殊配置说明

### 3.2 联系技术支持

**联系方式**：
- 邮箱: support@payermax.com
- 在线客服: 开发者中心
- 技术文档: https://docs.payermax.com

**邮件模板**：
```
主题: [验收申请] 商户名称 - 收银台集成

您好，

我们已完成PayerMax收银台集成的开发和测试，现申请验收。

商户信息:
- 商户名称: XXX
- 商户号: TEST123456
- AppID: testxxx
- 联系人: 张三
- 联系方式: zhangsan@example.com

测试订单信息:
[粘贴测试订单列表]

集成说明:
- 集成模式: 收银台模式
- 支持支付方式: CARD, WALLET
- 支持国家: US, ID, PH
- 支持货币: USD, IDR

请协助验收，谢谢！

此致
敬礼
```

### 3.3 验收检查项

PayerMax技术支持会检查以下内容：

#### 请求日志检查
- [ ] 请求格式正确
- [ ] 签名生成正确
- [ ] 参数设置合理

#### 响应处理检查
- [ ] 正确处理成功响应
- [ ] 正确处理错误响应
- [ ] 正确解析响应数据

#### 回调处理检查
- [ ] 正确验证回调签名
- [ ] 正确处理回调数据
- [ ] 快速返回响应
- [ ] 实现幂等性

#### 安全性检查
- [ ] 使用HTTPS
- [ ] 密钥安全
- [ ] 数据验证完整

## 4. 验收通过

### 4.1 获取生产环境信息

验收通过后，PayerMax会提供：
- 生产商户号
- 生产AppID
- 生产环境密钥对
- 生产环境配置说明

### 4.2 配置生产环境

#### 4.2.1 更新环境地址

将请求地址从测试环境切换到生产环境：
```
测试: https://pay-gate-uat.payermax.com/aggregate-pay/api/gateway/
生产: https://pay-gate.payermax.com/aggregate-pay/api/gateway/
```

#### 4.2.2 更新商户信息

```javascript
// 测试环境
const config = {
  merchantNo: 'TEST123456',
  appId: 'testxxx',
  privateKey: 'test_private_key',
  publicKey: 'test_public_key',
  baseUrl: 'https://pay-gate-uat.payermax.com/aggregate-pay/api/gateway/'
};

// 生产环境
const config = {
  merchantNo: 'PROD123456',
  appId: 'prodxxx',
  privateKey: 'prod_private_key',
  publicKey: 'prod_public_key',
  baseUrl: 'https://pay-gate.payermax.com/aggregate-pay/api/gateway/'
};
```

#### 4.2.3 更新回调地址

在PayerMax商户平台配置生产环境的回调地址：
- 支付结果回调地址
- 退款结果回调地址

确保回调地址：
- 使用HTTPS
- 可以从公网访问
- 能够快速响应

### 4.3 生产环境测试

在正式开量前，进行小额真实支付测试：

**测试步骤**：
1. 使用真实金额创建订单（建议小额，如$0.01）
2. 完成真实支付
3. 验证回调通知
4. 验证订单查询
5. 检查资金到账

**检查项**：
- [ ] 支付流程正常
- [ ] 回调通知正常
- [ ] 订单状态正确
- [ ] 资金到账正确

## 5. 正式上线

### 5.1 灰度发布

建议采用灰度发布策略：

**阶段1: 小流量测试（1-5%）**
- 开放少量用户使用
- 密切监控支付成功率
- 及时处理异常

**阶段2: 中流量测试（10-30%）**
- 逐步扩大用户范围
- 继续监控各项指标
- 优化用户体验

**阶段3: 全量发布（100%）**
- 开放所有用户
- 持续监控和优化

### 5.2 监控指标

建议监控以下指标：

#### 业务指标
- 支付成功率
- 平均支付时长
- 用户支付转化率
- 各支付方式占比

#### 技术指标
- API请求成功率
- API响应时间
- 回调接收成功率
- 异常错误数量

#### 资金指标
- 交易金额
- 交易笔数
- 退款金额
- 退款笔数

### 5.3 告警设置

建议设置以下告警：

**紧急告警**：
- 支付成功率低于90%
- API请求失败率超过5%
- 回调接收失败率超过5%

**重要告警**：
- 支付成功率低于95%
- API响应时间超过3秒
- 单笔大额交易（如超过$1000）

**一般告警**：
- 支付成功率低于98%
- 异常错误数量增加

### 5.4 应急预案

准备应急预案，应对可能的问题：

**场景1: 支付成功率突然下降**
- 检查PayerMax服务状态
- 检查商户服务状态
- 检查网络连接
- 联系PayerMax技术支持

**场景2: 回调通知失败**
- 检查回调地址是否可访问
- 检查服务器负载
- 使用订单查询接口补偿
- 实施对账机制

**场景3: 资金异常**
- 立即暂停支付
- 核对订单数据
- 联系PayerMax技术支持
- 进行资金对账

## 6. 持续优化

### 6.1 定期对账

建议每天进行对账：
- 对比商户订单和PayerMax订单
- 核对交易金额
- 处理差异订单

### 6.2 性能优化

根据监控数据优化性能：
- 优化API调用
- 优化回调处理
- 优化数据库查询
- 使用缓存

### 6.3 用户体验优化

根据用户反馈优化体验：
- 优化页面跳转流程
- 优化支付方式展示
- 优化错误提示
- 优化移动端体验

### 6.4 安全加固

持续加强安全措施：
- 定期更新密钥
- 加强日志审计
- 实施风控规则
- 防范欺诈交易

## 7. 常见问题

### 7.1 测试阶段常见问题

**Q: 签名验证失败**
A: 检查密钥是否正确，签名算法是否正确，参数顺序是否正确

**Q: 收不到回调通知**
A: 检查回调地址是否可访问，是否使用HTTPS，防火墙是否开放

**Q: 订单查询返回不存在**
A: 检查订单号是否正确，是否使用了正确的环境

### 7.2 上线阶段常见问题

**Q: 生产环境支付失败**
A: 检查是否使用了生产环境配置，商户号和AppID是否正确

**Q: 资金未到账**
A: 联系PayerMax财务团队，提供订单号和交易时间

**Q: 支付成功率低**
A: 分析失败原因，优化支付流程，联系PayerMax技术支持

## 8. 支持渠道

### 技术支持
- 邮箱: support@payermax.com
- 电话: +86 xxx-xxxx-xxxx
- 在线客服: 开发者中心

### 文档资源
- 开发者文档: https://docs.payermax.com
- API参考: https://api-docs.payermax.com
- 常见问题: https://faq.payermax.com

### 商务合作
- 邮箱: business@payermax.com
- 电话: +86 xxx-xxxx-xxxx
