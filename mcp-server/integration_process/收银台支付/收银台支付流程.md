# 收银台支付流程

## 完整支付流程

```
1. 商户创建支付订单
   ↓
2. 获取PayerMax收银台URL
   ↓
3. 跳转到PayerMax收银页
   ↓
4. 用户选择支付方式
   ↓
5. 用户完成支付
   ↓
6. 跳转到PayerMax支付结果页
   ↓
7. 用户点击返回按钮
   ↓
8. 跳转到商户页面
   ↓
9. PayerMax异步通知支付结果
   ↓
10. 商户确认支付结果
```

## 步骤详解

### 步骤1: 创建支付订单

商户调用 `/orderAndPay` API 接口，发起HTTP POST请求，创建支付订单。

**关键操作**：
- 准备订单数据（金额、货币、商品描述等）
- 生成唯一的商户订单号
- 配置回调地址
- 生成请求签名
- 发送HTTP请求

### 步骤2: 获取PayerMax收银台URL

PayerMax处理请求后，返回响应数据，其中包含：
- `redirectUrl`: PayerMax收银台页面URL
- `tradeToken`: PayerMax交易单号
- `status`: 订单状态（PENDING）

**响应示例**：
```json
{
  "code": "APPLY_SUCCESS",
  "data": {
    "redirectUrl": "https://cashier-n.payermax.com/v2/index.html#/payments?...",
    "outTradeNo": "PTEST93137249",
    "tradeToken": "T2019051406423972799219",
    "status": "PENDING"
  }
}
```

### 步骤3: 跳转到PayerMax收银页

商户接收到响应后，重定向用户浏览器到 `redirectUrl`。

**跳转方式**：
- Web端: `window.location.href = redirectUrl`
- 移动端: 使用WebView加载URL
- 服务端: 返回302重定向

### 步骤4: 用户选择支付方式

用户在PayerMax收银页看到可用的支付方式列表。

**收银页特性**：
- 自适应设备屏幕大小
- 支持多语言显示
- 展示商户指定的支付方式
- 显示订单金额和商品信息

**用户操作**：
- 浏览可用支付方式
- 选择一个支付方式
- 点击确认支付

### 步骤5: 用户完成支付

根据选择的支付方式，用户完成支付操作。

**不同支付方式的流程**：

#### 卡支付
1. 输入卡号、有效期、CVV
2. 输入持卡人信息
3. 完成3DS验证（如需要）
4. 支付完成

#### 电子钱包
1. 跳转到钱包应用或页面
2. 登录钱包账户
3. 确认支付
4. 返回PayerMax

#### 银行转账
1. 选择银行
2. 跳转到网银页面
3. 完成转账
4. 返回PayerMax

### 步骤6: 跳转到PayerMax支付结果页

支付完成后，PayerMax自动跳转到支付结果页。

**支付结果页展示**：
- 支付成功或失败的提示
- 订单金额和商品信息
- "关闭"或"返回"按钮

**页面示例**：
```
✓ 支付成功

订单金额: $3.99
商品: diamond 700

[返回商户]
```

### 步骤7: 用户点击返回按钮

用户点击"关闭"或"返回"按钮。

### 步骤8: 跳转到商户页面

PayerMax跳转到商户指定的 `frontCallbackUrl`。

#### 跳转URL格式

完整URL = `frontCallbackUrl` + PayerMax附加参数

**示例**：
```
https://your-payment.example.com/payment/front_callback?flag=ipaMbjQuest&outTradeNo=PTEST93137249&tradeToken=T2019051406423972799219&status=SUCCESS
```

#### PayerMax附加的参数

| 参数名 | 说明 |
|-------|------|
| outTradeNo | 商户订单号 |
| tradeToken | PayerMax订单号 |
| status | 订单状态 |

#### frontCallbackUrl配置方式

商户可以根据业务需求选择不同的URL形式：

##### 1. 普通H5页面（不推荐）

**格式**: `https://your-domain.com/payment/result`

**特点**：
- 停留在系统浏览器
- 展示H5页面
- 不具备唤起APP能力

**适用场景**: 纯Web应用

##### 2. 内置主动唤起APP逻辑的H5（推荐）

**格式**: `https://your-domain.com/payment/result`

**特点**：
- 展示H5页面
- 页面内逻辑主动识别场景
- 尝试唤起商户APP
- 唤起失败则停留在H5页面

**优点**：
- 逻辑灵活
- 流程可控
- 用户体验好

**缺点**：
- 开发复杂
- 需要搭配URL Scheme或AppLink使用

**实现示例**：
```html
<!DOCTYPE html>
<html>
<head>
    <title>支付结果</title>
</head>
<body>
    <h1>支付成功</h1>
    <p>正在返回应用...</p>
    <script>
        // 尝试唤起APP
        var scheme = 'yourapp://payment/result?orderId=xxx';
        window.location.href = scheme;
        
        // 2秒后如果还在页面，说明唤起失败
        setTimeout(function() {
            document.body.innerHTML = '<h1>支付成功</h1><p>请手动返回应用</p>';
        }, 2000);
    </script>
</body>
</html>
```

##### 3. URL Scheme（不推荐）

**格式**: `yourapp://payment/result`

**特点**：
- 系统自动尝试唤起APP
- APP存在且有权限则打开
- APP不存在或无权限则展示空白页

**优点**：
- 简单易开发

**缺点**：
- 无降级逻辑
- 未唤起APP时展示空白页
- 用户体验差

##### 4. AppLink/Universal Link（推荐）

**格式**: `https://your-domain.com/payment/result`

**特点**：
- 系统自动尝试唤起APP
- APP存在且有权限则打开
- APP不存在或无权限则展示H5页面

**优点**：
- 开发逻辑相对简单
- 可降级使用H5处理业务逻辑
- 用户体验好

**缺点**：
- 需要配置域名验证文件
- iOS和Android配置方式不同

#### frontCallbackUrl对比表

| URL形式 | 支付完成后跳转流程 | 是否推荐 | 优点 | 缺点 |
|---------|------------------|---------|------|------|
| 普通H5 | 停留在系统浏览器，展示H5页面 | 否 | 无 | 不具备唤起APP能力 |
| 内置唤起逻辑H5 | 展示H5页面，同时尝试唤起APP | 是 | 逻辑灵活、流程可控 | 开发复杂 |
| URL Scheme | 尝试唤起APP，失败则空白页 | 否 | 简单易开发 | 无降级逻辑 |
| AppLink/Universal Link | 尝试唤起APP，失败则H5页面 | 是 | 相对简单、可降级 | 需要域名配置 |

### 步骤9: PayerMax异步通知支付结果

PayerMax通过异步回调通知商户支付结果。

**通知方式**：
- PayerMax向商户的 `notifyUrl` 发送POST请求
- 包含完整的支付结果信息
- 商户需要验证签名
- 商户返回成功响应

**重要性**：
- 这是商户确认支付结果的主要方式
- 不要依赖前端跳转的status参数
- 必须验证回调签名
- 必须处理重复通知

详细信息请查看支付结果通知文档。

### 步骤10: 商户确认支付结果

商户通过以下方式确认支付结果：

#### 方式1: 接收异步通知（推荐）

**流程**：
1. 接收PayerMax的POST请求
2. 验证请求签名
3. 解析支付结果
4. 更新订单状态
5. 返回成功响应

**优点**：
- 实时性好
- 可靠性高
- PayerMax会重试

#### 方式2: 主动查询（补充）

**流程**：
1. 调用 `/orderQuery` API
2. 传入商户订单号或PayerMax订单号
3. 获取最新的订单状态
4. 更新订单状态

**使用场景**：
- 未收到异步通知
- 需要实时查询状态
- 对账和核对

详细信息请查看支付订单查询文档。

## 状态流转

```
PENDING (待支付)
   ↓
PROCESSING (处理中)
   ↓
SUCCESS (成功) / FAILED (失败) / CANCELLED (已取消)
```

### 状态说明

| 状态 | 说明 | 后续操作 |
|------|------|---------|
| PENDING | 订单已创建，等待用户支付 | 等待支付完成 |
| PROCESSING | 支付处理中 | 等待最终结果 |
| SUCCESS | 支付成功 | 发货或提供服务 |
| FAILED | 支付失败 | 提示用户重新支付 |
| CANCELLED | 订单已取消 | 无需处理 |

## 超时处理

### 支付超时

如果用户在 `expireTime` 时间内未完成支付：
1. PayerMax系统自动关单
2. 订单状态变为CANCELLED
3. 用户无法继续支付
4. 商户收到取消通知

### 建议

- 设置合理的过期时间（建议30分钟以上）
- 提示用户剩余支付时间
- 超时后引导用户重新下单

## 异常处理

### 网络异常

**场景**: 创建支付时网络超时

**处理**：
1. 不要立即重新创建订单
2. 先查询订单状态
3. 如果订单不存在，再创建新订单
4. 避免重复下单

### 用户中途退出

**场景**: 用户在支付过程中关闭页面

**处理**：
1. 订单保持PENDING状态
2. 用户可以重新打开收银台继续支付
3. 超时后自动关单

### 回调失败

**场景**: 商户服务器未收到支付结果通知

**处理**：
1. PayerMax会自动重试（最多3次）
2. 商户可以主动查询订单状态
3. 建议实现对账机制

## 安全建议

1. **验证签名**: 必须验证所有来自PayerMax的请求签名
2. **HTTPS**: 所有回调地址必须使用HTTPS
3. **幂等性**: 处理回调时要考虑重复通知
4. **金额校验**: 验证回调中的金额与订单金额一致
5. **状态校验**: 只有SUCCESS状态才发货
6. **日志记录**: 记录所有关键操作和异常情况

## 最佳实践

1. **订单号管理**: 使用有意义的订单号格式，便于追踪
2. **状态机**: 使用状态机管理订单状态流转
3. **异步处理**: 回调处理使用异步队列，快速返回响应
4. **监控告警**: 监控支付成功率和异常情况
5. **对账机制**: 定期对账，确保数据一致性
6. **用户体验**: 优化页面跳转流程，减少用户等待时间

## 注意事项

1. **不要依赖前端参数**: frontCallbackUrl中的status参数仅供参考，不能作为最终支付结果
2. **保证回调地址可访问**: notifyUrl必须能从公网访问
3. **处理重复通知**: 同一笔订单可能收到多次通知，要做幂等处理
4. **及时响应回调**: 收到回调后应在5秒内返回响应
5. **保存tradeToken**: PayerMax订单号用于查询和售后
