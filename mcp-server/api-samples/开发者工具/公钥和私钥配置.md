# 公钥和私钥配置 - 示例和快速参考

## 快速生成密钥对

### 方法1：在线工具（推荐）
访问：https://developer.payermax.com/tools
- 纯JS实现，无服务器交互
- 安全可靠，不会泄露密钥

### 方法2：OpenSSL命令

```bash
# 生成私钥
openssl genrsa 2048 | openssl pkcs8 -topk8 -nocrypt -out private.key.pem

# 生成公钥
openssl rsa -in private.key.pem -pubout > public.key.pem
```

### 方法3：SDK生成

```java
// Java SDK
String[] keyPair = PayerMaxUtil.createKeyPair();
String publicKey = keyPair[0];
String privateKey = keyPair[1];
```

```php
// PHP SDK
$keyPair = PayerMaxUtil::createKeyPair();
$publicKey = $keyPair['publicKey'];
$privateKey = $keyPair['privateKey'];
```

## 密钥格式处理

生成的PEM文件需要去除头尾和换行符：

**原始公钥文件：**
```
-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAzN6tx98b4KZB1uqEuT7P
/nWHrYqFdiy+Kzs9KZ6JtSQWb3b45loOsdUxFeaCAt+ZJ0+fNJRDnwc7AiKOlgbw
...
-----END PUBLIC KEY-----
```

**处理后的公钥字符串：**
```
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAzN6tx98b4KZB1uqEuT7P/nWHrYqFdiy+Kzs9KZ6JtSQWb3b45loOsdUxFeaCAt+ZJ0+fNJRDnwc7AiKOlgbw...
```

## 签名算法规格

| 参数 | 值 |
|------|-----|
| 算法 | RSA |
| 密钥格式 | PKCS8 |
| 签名算法 | SHA256WithRSA |
| 密钥长度 | 2048 bits |

## JSON格式化注意事项

⚠️ **重要：JSON格式影响签名结果**

### 错误示例：格式化后签名不一致

```json
// 格式化的JSON
{
  "key1": "val1",
  "key2": "val2"
}
// 签名: FPFVT3o227JrFRbqu19boZCpVVTF9Kzn...

// 压缩的JSON
{"key1":"val1","key2":"val2"}
// 签名: W/unZQUH9366PZDhYlCghA7q66VmPDBN...
```

### 正确做法

```javascript
// 1. 生成JSON字符串
const jsonString = JSON.stringify(requestData);

// 2. 使用该字符串进行签名
const signature = signWithPrivateKey(jsonString, merchantPrivateKey);

// 3. 使用相同的字符串作为HTTP body
httpRequest.body = jsonString;
httpRequest.headers['sign'] = signature;
```

## 请求示例

```http
POST https://pay-gate.payermax.com/aggregate-pay/api/gateway/orderAndPay
Content-Type: application/json
sign: <使用商户私钥对body进行SHA256WithRSA签名>

{"version":"1.1","keyVersion":"1","requestTime":"2022-01-17T08:04:13.879+00:00","appId":"3b242b56a8b64274bcc37dac281120e3","merchantNo":"020213827212251","data":{"outTradeNo":"Pay1642406653879","subject":"MacPro14 and Mouse","totalAmount":"10000","currency":"IDR","country":"ID","userId":"10001","language":"en","reference":"020213827524152","frontCallbackURL":"https://www.payermax.com","notifyUrl":"https://www.payermax.com"}}
```

## 响应验签示例

```http
HTTP/1.1 200 OK
Content-Type: application/json
sign: <PayerMax使用私钥对body进行签名>

{"code":"APPLY_SUCCESS","msg":"","data":{"redirectUrl":"https://cashier-n.payermax.com/...","outTradeNo":"Pay1642406653879","tradeToken":"TOKEN20220117080414618354880","status":"PENDING"}}
```

### 验签步骤

```javascript
// 1. 提取响应body和sign header
const responseBody = response.body;
const signature = response.headers['sign'];

// 2. 使用PayerMax公钥验证签名
const isValid = verifySignature(responseBody, signature, payermaxPublicKey);

// 3. 验证通过后处理响应数据
if (isValid) {
    const data = JSON.parse(responseBody);
    // 处理业务逻辑
} else {
    // 签名验证失败，可能被篡改
    throw new Error('Signature verification failed');
}
```

## 常见错误

### 1. 签名验证失败
- **原因**：JSON格式不一致
- **解决**：确保签名和传输使用相同的JSON字符串

### 2. 密钥格式错误
- **原因**：未去除PEM头尾或包含换行符
- **解决**：使用纯密钥字符串（无BEGIN/END标记，无换行）

### 3. 环境配置混淆
- **原因**：测试环境密钥用于生产环境
- **解决**：严格区分测试和生产环境的appId和密钥对

## 测试工具

使用PayerMax开发者工具进行签名测试：
- **自助加签工具**：验证签名生成是否正确
- **在线密钥生成**：快速生成测试用密钥对
- **访问地址**：https://developer.payermax.com/tools

## 安全最佳实践

1. ✅ 私钥严格保密，不要提交到代码仓库
2. ✅ 使用环境变量或密钥管理服务存储私钥
3. ✅ 测试和生产环境使用不同的密钥对
4. ✅ 定期轮换密钥（建议每年至少一次）
5. ✅ 密钥泄露后立即更换并通知PayerMax
6. ✅ 始终验证PayerMax响应的签名
7. ✅ 使用HTTPS传输所有API请求
