# PayerMax管理订阅计划

## 1. 交互流程

PayerMax 订阅计划服务为商户提供灵活的周期性扣款解决方案，支持多种订阅模式，满足不同业务场景的需求。

## 2. 订阅计划规则说明

### 2.1 支持的订阅类型

- **标准订阅**: 按固定周期进行自动扣款的订阅服务
- **试用期订阅**: 提供免费试用期后转为付费订阅的服务
- **优惠期订阅**: 前若干期享受优惠价格的订阅服务

### 2.2 服务限制说明

> **特别提醒**: PayerMax 管理的单个订阅计划总时长不得超过3年。

#### 激活时效要求

订阅计划需在规定时间内完成激活，具体要求如下：

1. 订阅计划必须在首期扣款开始时间之前完成激活
2. 若首期扣款时间与订阅创建时间间隔超过24小时，则需在创建后24小时内完成激活
3. 超过时效未激活的订阅计划将被系统标记为过期未激活状态，PayerMax将向商户发送过期通知

### 2.3 扣款与通知规则

#### 2.3.1 扣款结果通知规则

| 扣款结果 | 通知时机 | 说明 |
|---------|---------|------|
| 扣款成功 | 立即通知 | 扣款成功后，系统立即向商户发送通知 |
| 扣款失败 | 延迟通知 | 仅在该期最后一次扣款失败后向商户发送通知 |

#### 2.3.2 扣款失败重试机制

当扣款失败时，PayerMax 将自动执行重试机制：

- 系统在重试期间不会向商户发送失败通知，避免频繁通知影响商户系统
- 重试策略根据商户配置的扣款策略（默认策略/提前扣款策略/宽限扣款策略）自动执行
- 仅在所有重试均失败后，系统才会发送最终失败通知

### 2.4 扣款失败处理策略

#### 2.4.1 默认处理策略

**策略说明**：
- 订阅激活后，后续扣款由PayerMax系统自动发起
- 当扣款失败时，系统每天重试3次
- 若该期最后一天最后一次扣款仍然失败，则订阅计划自动终止

#### 2.4.2 扣款失败不终止订阅策略

**策略说明**：
- 当某期最后一次重试扣款失败后，订阅计划不会终止，订阅状态保持激活
- 该期无法继续扣款，但下一期开始后，系统将正常发起扣款

**配置方式**：
- 此策略需联系PayerMax技术支持团队进行配置
- 配置以商户号维度生效，配置完成后对该商户号下所有订阅计划立即生效

### 2.5 扣款时机策略

> **特别提醒**: 同一商户号不能同时配置提前扣款策略和宽限扣款策略，商户需根据业务需求选择其中一种策略。

#### 2.5.1 默认扣款策略

**执行流程**：
1. 系统提前1天生成下一期扣款账单
2. 账单生成后立即发起扣款
3. 扣款失败时，系统每天重试3次
4. 若3次重试均失败，则执行商户配置的扣款失败处理策略

#### 2.5.2 提前扣款策略

**策略说明**：
提前扣款策略允许商户在订阅周期结束前若干天发起扣款，为用户提供更充裕的资金准备时间。

**配置方式**：

**方式一：单次指定配置**
- 在创建订阅时通过 `advanceDays` 参数指定提前扣款天数
- 优点：灵活性高，可针对单个订阅进行配置
- 缺点：需要每次创建时手动指定，管理成本较高

**方式二：统一配置（推荐）**
- 联系PayerMax技术支持团队进行统一配置，创建订阅时无需指定 `advanceDays` 参数
- 配置维度：以商户号维度进行配置
- 生效时机：配置完成后，在生成下一期扣款账单时生效

**提前扣款天数配置规则**：

| 订阅周期类型 | 周期数量范围 | 允许的提前扣款天数 |
|------------|------------|------------------|
| periodUnit=天(D) | 1 ≤ periodCount < 7 | 不支持提前扣款 |
| | 7 ≤ periodCount < 30 | 1-2 天 |
| | 30 ≤ periodCount < 90 | 1-5 天 |
| | periodCount ≥ 90 | 1-7 天 |
| periodUnit=周(W) | 1 ≤ periodCount < 4 | 1-2 天 |
| | 4 ≤ periodCount < 12 | 1-5 天 |
| | periodCount ≥ 12 | 1-7 天 |
| periodUnit=月(M) | 1 ≤ periodCount < 3 | 1-5 天 |
| | periodCount ≥ 3 | 1-7 天 |
| periodUnit=年(Y) | 1 ≤ periodCount ≤ 3 | 1-7 天 |

**配置示例**：
- 示例1：订阅周期为每7天，可配置提前1-2天扣款
- 示例2：订阅周期为每3个月，可配置提前1-7天扣款

#### 2.5.3 宽限扣款策略

**策略说明**：
宽限扣款策略是指在正常扣款失败后，系统在宽限期内继续尝试扣款，为用户提供额外的付款时间窗口，避免因短期资金问题导致订阅立即终止。

**配置方式**：
- 联系 PayerMax 技术支持团队进行配置
- 配置维度：以商户号维度进行配置
- 生效时机：配置完成后，在生成下一期扣款账单时生效

**执行流程**：
1. 系统提前1天生成扣款账单并发起扣款
2. 扣款失败时，系统每天重试3次
3. 若3次重试均失败，订阅进入宽限期
4. 宽限期内，系统在指定日期各执行1次扣款
5. 宽限期内任一次扣款成功，则停止后续扣款
6. 宽限期最后一天扣款失败后，执行商户配置的扣款失败处理策略

**宽限期天数扣款规则**：

| 订阅周期类型 | 周期数量范围 | 宽限期可执行扣款的日期 |
|------------|------------|---------------------|
| periodUnit=天(D) | 1 ≤ periodCount < 7 | 第 1 天 |
| | 7 ≤ periodCount < 30 | 第 1, 2, 5 天 |
| | 30 ≤ periodCount < 90 | 第 1, 2, 5, 7, 10 天 |
| | periodCount ≥ 90 | 第 1, 2, 5, 7, 10, 15 天 |
| periodUnit=周(W) | 1 ≤ periodCount < 4 | 第 1, 2, 5 天 |
| | 4 ≤ periodCount < 12 | 第 1, 2, 5, 7, 10 天 |
| | periodCount ≥ 12 | 第 1, 2, 5, 7, 10, 15 天 |
| periodUnit=月(M) | 1 ≤ periodCount < 3 | 第 1, 2, 5, 7, 10 天 |
| | periodCount ≥ 3 | 第 1, 2, 5, 7, 10, 15 天 |
| periodUnit=年(Y) | 1 ≤ periodCount ≤ 3 | 第 1, 2, 5, 7, 10, 15 天 |

**配置示例**：

**示例1：订阅周期为每7天，配置宽限期5天**
- 正常扣款失败后，系统在该期开始后第1天、第2天、第5天各执行1次扣款
- 期间任一次扣款成功，则停止后续扣款
- 所有宽限期扣款均失败，则执行扣款失败处理策略

**示例2：订阅周期为每3个月，配置宽限期15天**
- 正常扣款失败后，系统在该期开始后第1天、第2天、第5天、第7天、第10天、第15天各执行1次扣款
- 期间任一次扣款成功，则停止后续扣款
- 所有宽限期扣款均失败，则执行扣款失败处理策略

### 2.6 策略配置说明

#### 2.6.1 配置维度

所有扣款策略配置均以商户号维度进行，配置完成后对该商户号下的订阅计划生效。

#### 2.6.2 配置生效时机

| 策略类型 | 生效时机 |
|---------|---------|
| 扣款失败处理策略 | 配置完成后对所有订阅计划立即生效 |
| 提前扣款策略 | 配置完成后，在生成下一期扣款账单时生效 |
| 宽限扣款策略 | 配置完成后，在生成下一期扣款账单时生效 |

## 3. 订阅计划状态说明

| 状态值 | 状态说明 | 备注 |
|-------|---------|------|
| INACTIVE | 未激活 | 创建订阅计划后，状态为未激活 |
| ACTIVE_FAILED | 激活失败 | 激活失败后的状态 |
| ACTIVE | 生效中 | 激活成功后的状态 |
| TERMINATE | 订阅终止 | 某期扣款失败后，订阅计划会终止 |
| CANCEL | 订阅取消 | 主动取消订阅计划 |
| FINISH | 订阅完成 | 订阅计划所有期数都完成扣款 |
| EXPIRED | 过期未激活 | 首期扣款时间开始后，还未激活订阅计划 |

## 4. 订阅扣款状态说明

| 状态值 | 状态说明 |
|-------|---------|
| PENDING | 扣款中 |
| SUCCESS | 扣款成功 |
| FAILED | 扣款失败 |
