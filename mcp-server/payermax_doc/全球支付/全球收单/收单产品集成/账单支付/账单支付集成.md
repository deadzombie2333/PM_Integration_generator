# 账单支付集成

## 1. 业务介绍

账单支付是在部分国家很流行的一种支付形式，通常应用于用户缴纳水电费、学费，还贷等场景。

### 特点

- **覆盖多种支付方式**：信用卡、借记卡、电子钱包、银行转账、线下便利店等
- **用户主动还款**：用户在各个APP或资产设备中输入交易单号或还款合约、还款金额进行主动还款
- **确认入账机制**：PayerMax在确认入账后返回对应商户交易状态并通知

### 应用场景

- 水电费缴纳
- 学费支付
- 贷款还款
- 其他账单类支付

## 2. 业务流程

账单支付的完整业务流程包括：

1. 用户发起账单支付请求
2. PayerMax调用商户的账单支付校验接口，验证支付可行性
3. 商户返回校验结果（是否可以支付）
4. 用户完成支付操作
5. PayerMax确认对客扣款成功
6. PayerMax调用商户的支付成功通知接口
7. 商户进行内部入账处理
8. 商户返回入账结果给PayerMax（同步或异步）

## 3. 用户体验

### 以菲律宾GCASH的账单支付为例

用户端的支付流程：

1. 用户在GCASH APP中选择账单支付功能
2. 输入商户提供的交易单号或还款合约号
3. 输入还款金额
4. 确认支付信息
5. 完成支付操作
6. 收到支付成功通知

## 4. API集成

### 接口列表

| 接口名称 | 接口地址 | 描述 |
|---------|---------|------|
| 账单支付校验接口 | `/billPaymentValidationUrl` | PayerMax调用该接口请求商户获取本次支付操作的可行性（是否能够支付） |
| 支付成功通知商户 | `/collectResultNotifyUrlForBillPayment` | 对客扣款成功后，PayerMax将调用该接口通知商户入账结果，商户无需响应data |
| 商户入账结果确认 | `/aggregate-pay/api/gateway/orderConfirm` | 商户收到支付通知且进行内部入账处理后，返回给PayerMax最终的入账结果 |

### 重要说明

⚠️ **入账结果返回机制**：

PayerMax提供商户入账结果的**同步返回**和**异步回调**两种方式：

1. **同步返回**：若商户在【支付成功通知】接口中同步返回入账结果，则商户**无需对接**【入账结果通知】接口
2. **异步回调**：若商户在【支付成功通知】接口中不返回入账结果，则商户**需对接**【入账结果通知】接口返回入账结果
3. **优先级规则**：若商户对接了两个接口且都分别返回入账结果，则PayerMax**只处理第一次**的入账结果

### 集成方式选择

商户可根据自身业务需求选择以下集成方式之一：

- **方式一（推荐）**：在【支付成功通知】接口中同步返回入账结果
  - 优点：流程简单，实时响应
  - 适用场景：入账处理逻辑简单，可快速完成

- **方式二**：使用【商户入账结果确认】接口异步返回入账结果
  - 优点：适合复杂的入账处理逻辑
  - 适用场景：需要较长时间处理入账逻辑的场景

## 5. 接口详细说明

### 5.1 账单支付校验接口

**接口地址**：`/billPaymentValidationUrl`（商户提供）

**调用方**：PayerMax → 商户

**用途**：PayerMax在用户发起支付前，调用商户接口验证本次支付操作的可行性

**商户需要验证的内容**：
- 交易单号或还款合约是否有效
- 还款金额是否正确
- 账单状态是否允许支付
- 其他业务规则验证

### 5.2 支付成功通知商户接口

**接口地址**：`/collectResultNotifyUrlForBillPayment`（商户提供）

**调用方**：PayerMax → 商户

**用途**：对客扣款成功后，PayerMax通知商户入账结果

**商户处理逻辑**：
- 接收PayerMax的支付成功通知
- 进行内部入账处理
- 可选择同步返回入账结果（推荐）

**注意**：商户无需在响应中返回data字段

### 5.3 商户入账结果确认接口

**接口地址**：`/aggregate-pay/api/gateway/orderConfirm`（PayerMax提供）

**调用方**：商户 → PayerMax

**用途**：商户完成内部入账处理后，主动通知PayerMax最终的入账结果

**使用场景**：
- 商户在【支付成功通知】接口中未同步返回入账结果
- 商户需要异步处理入账逻辑

## 6. 集成注意事项

### 6.1 接口幂等性

- 商户需要保证接口的幂等性，避免重复入账
- 使用交易单号作为唯一标识进行去重

### 6.2 超时处理

- 建议商户接口响应时间控制在5秒以内
- 超时情况下，PayerMax会进行重试

### 6.3 安全性

- 所有接口通信需要进行签名验证
- 使用HTTPS协议保证数据传输安全
- 验证请求来源的合法性

### 6.4 错误处理

- 明确返回错误码和错误信息
- 区分业务错误和系统错误
- 提供清晰的错误描述便于问题排查

## 7. 测试建议

### 7.1 功能测试

- 测试正常支付流程
- 测试支付校验失败场景
- 测试入账成功和失败场景
- 测试重复通知的幂等性

### 7.2 异常测试

- 测试网络超时场景
- 测试接口返回异常
- 测试并发支付场景

### 7.3 集成验证

- 验证签名机制正确性
- 验证回调URL配置正确
- 验证入账结果返回机制

## 8. 常见问题

### Q1: 如何选择同步还是异步返回入账结果？

**A**: 
- 如果入账处理逻辑简单，可在3-5秒内完成，建议使用同步返回
- 如果入账处理复杂，需要较长时间，建议使用异步返回

### Q2: 如果同时实现了两种返回方式会怎样？

**A**: PayerMax只处理第一次收到的入账结果，后续的结果会被忽略

### Q3: 账单支付支持哪些国家和支付方式？

**A**: 账单支付在部分国家流行，具体支持的国家和支付方式请咨询PayerMax商务团队

### Q4: 如何处理支付成功但入账失败的情况？

**A**: 商户应在入账结果中明确返回失败状态，PayerMax会根据结果进行相应处理，可能触发退款流程
