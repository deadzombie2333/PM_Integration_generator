# 公钥和私钥配置

## 4.1 公钥和私钥的作用

商户私钥用于请求PayerMax报文的加签操作，商户需妥善保管。商户公钥通过Merchant Dashboard平台上传给PayerMax，用于验证商户签名，防止报文在网络传输过程中被篡改。同时在平台上获取PayerMax公钥放到自己程序中，用于验证PayerMax加签报文的签名。

## 4.2 如何生成公钥私钥

商户公私钥可通过如下三种方式进行生成（任选其一即可）：

### 方式1：在线生成密钥对

通过PayerMax提供的开发者工具，在线生成密钥对。工具为纯JS实现，不会和PayerMax服务器进行交互，不会泄露商户密钥信息。

**生成地址**: [开发者工具](https://developer.payermax.com/tools)

### 方式2：SDK生成

SDK提供了开发相关工具类中的`createKeyPair`方法或者函数也可以生成。

- [Java SDK](https://github.com/PayerMax/payermax-server-sdk-java)
- [PHP SDK](https://github.com/PayerMax/payermax-server-sdk-php)

### 方式3：OpenSSL生成

通过OpenSSL命令生成PEM公私钥文件并手动去除开头、结尾、换行符得到公私钥信息。

#### 步骤：

1. 下载并安装OpenSSL，参考文档：https://www.openssl.org/source/

2. 执行如下命令：

```bash
# 生成私钥
openssl genrsa 2048 | openssl pkcs8 -topk8 -nocrypt -out private.key.pem

# 生成公钥
openssl rsa -in private.key.pem -pubout > public.key.pem
```

3. 执行完上述命令后，会生成两个文件：

**公钥文件 public.key.pem**：
```
```

**私钥文件 private.key.pem**：
```
```

4. **注意：PKCS8需要去除开头、结尾、换行**

得到公钥字符串：
```

```

得到私钥字符串：
```

```

### 重要提示：JSON格式化对签名的影响

使用商户私钥进行加签的报文字符串要保证和HTTP body中的字符串是一致的，否则会导致PayerMax验签不通过。

您可以通过开发者【自助加签小工具】体验加签过程。

**示例：**

格式化的JSON字符串：
```json
{
  "key1": "val1",
  "key2": "val2",
  "key3": "val3"
}
```
使用示例私钥加签结果：
```

```

压缩的JSON字符串：
```json
{"key1":"val1","key2":"val2","key3":"val3"}
```
使用示例私钥加签结果：
```

```

## 4.3 签名算法

| 类型 | 说明 |
|------|------|
| 算法 | RSA |
| Key格式 | PKCS8 |
| 签名算法 | SHA256WithRSA |
| 密钥长度 | 2048 |

## 4.4 示例报文

### 请求报文

```http
POST https://pay-gate.payermax.com/aggregate-pay/api/gateway/orderAndPay
Content-Type: application/json
Content-Length: 580
sign: 根据请求body使用merchant privateKey签名

{
  "version": "1.1",
  "keyVersion": "1",
  "requestTime": "2022-01-17T08:04:13.879+00:00",
  "appId": "3b242b56a8b64274bcc37dac281120e3",
  "merchantNo": "020213827212251",
  "data": {
    "outTradeNo": "Pay1642406653879",
    "subject": "MacPro14 and Mouse",
    "totalAmount": "10000",
    "currency": "IDR",
    "country": "ID",
    "userId": "10001",
    "language": "en",
    "reference": "020213827524152",
    "frontCallbackURL": "https://www.payermax.com",
    "notifyUrl": "https://www.payermax.com"
  }
}
```

### 响应报文

```http
HTTP/1.1 200 OK
Date: Mon, 17 Jan 2022 03:49:08 GMT
Content-Type: application/json
Connection: keep-alive
sign: PayerMax签名信息，商户根据响应json body以及PayerMax publicKey验签

{
  "code": "APPLY_SUCCESS",
  "msg": "",
  "data": {
    "redirectUrl": "https://cashier-n.payermax.com/index.html#/cashier/home?merchantId=020213827212251&appId=3b242b56a8b64274bcc37dac281120e3&country=ID&tradeToken=TOKEN20220117080414618354880&language=en&token=LVDNgrtBcAvo0W6Zjhuons2jfZsEJXgFIAFDLf2Tq2I2FkdUhwF%2Fm8lxxmI1%2BVPfbPafUGFbZfTqagFOD3mMOAKm6790AZi7nuoQbG7SWFIyfD7hr0LbAy9TUpJNjm%2Bsxg2O%2FGvFpzpwP3P1JZxA%2BEajse7sQQubFZhFNGK9o9I%3D&amount=10000&currency=IDR&frontCallbackUrl=https%3A%2F%2Fwww.payermax.com",
    "outTradeNo": "Pay1642406653879",
    "tradeToken": "TOKEN20220117080414618354880",
    "status": "PENDING"
  }
}
```
